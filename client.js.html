<script>
    let rawData = [];
    let currentFilter = 'All';
    let colIndices = {
        type: 2,
        time: 3,
        date: 4,
        name: 1,
        distance: 5
    };

    // --- Constants ---
    const MS_PER_DAY = 24 * 60 * 60 * 1000;

    // --- Initialization ---
    window.addEventListener('DOMContentLoaded', () => {
        fetchData();
        setupFilters();
    });

    function setupFilters() {
        const buttons = document.querySelectorAll('.filter-btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Remove active class from all
                buttons.forEach(b => b.classList.remove('active'));
                // Add active to clicked
                e.target.classList.add('active');

                currentFilter = e.target.dataset.type;
                renderHeatmap();
            });
        });
    }

    function fetchData() {
        // Show loading?
        google.script.run
            .withSuccessHandler(onDataReceived)
            .withFailureHandler(error => {
                console.error("Error fetching data: ", error);
                document.getElementById('app').innerHTML = `<div class="error">Error loading data.</div>`;
            })
            .getData();
    }

    function onDataReceived(jsonString) {
        try {
            const data = JSON.parse(jsonString);
            if (data.length === 0) {
                rawData = [];
                renderHeatmap();
                return;
            }

            // Detect headers
            const header = data[0];
            const lowerHeader = header.map(h => String(h).toLowerCase());

            // Helper to find column index
            const findCol = (terms) => {
                return lowerHeader.findIndex(h => terms.some(t => h.includes(t)));
            };

            const typeIdx = findCol(['type', 'activity type']);
            const timeIdx = findCol(['moving time', 'duration', 'time']);
            const dateIdx = findCol(['start date', 'date', 'timestamp']);
            const nameIdx = findCol(['name', 'activity name', 'title']);
            const distanceIdx = findCol(['distance', 'dist']);

            // Update indices if found
            if (typeIdx !== -1) colIndices.type = typeIdx;
            if (timeIdx !== -1) colIndices.time = timeIdx;
            if (dateIdx !== -1) colIndices.date = dateIdx;
            if (nameIdx !== -1) colIndices.name = nameIdx;
            if (distanceIdx !== -1) colIndices.distance = distanceIdx;

            console.log('Detected column indices:', colIndices);

            // Shift if the first row looks like a header (contains "Activity" or "Date")
            if (lowerHeader.some(h => h.includes('activity') || h.includes('date') || h.includes('id'))) {
                data.shift();
            }

            rawData = data;
            renderHeatmap();
        } catch (e) {
            console.error("Error processing data", e);
            document.getElementById('app').innerHTML = `<div class="error">Error processing data.</div>`;
        }
    }

    function parseDuration(val) {
        if (typeof val === 'number') return val;
        if (!val) return 0;

        const str = String(val);

        // Handle HH:mm:ss or mm:ss
        if (str.includes(':') && !str.includes('T')) {
            const parts = str.split(':').map(Number);
            if (parts.length === 3) {
                return (parts[0] * 3600) + (parts[1] * 60) + parts[2];
            } else if (parts.length === 2) {
                return (parts[0] * 60) + parts[1];
            }
        }

        // Handle ISO string from GAS (e.g., 1899-12-30T00:49:03.000Z)
        if (str.includes('T')) {
            const d = new Date(val);
            if (!isNaN(d.getTime())) {
                // durations in Sheets serialized to JSON often look like 1899-12-30T...
                // We want the hours/mins/secs regardless of the date part
                return (d.getHours() * 3600) + (d.getMinutes() * 60) + d.getSeconds();
            }
        }

        const num = Number(val);
        return isNaN(num) ? 0 : num;
    }

    function processData() {
        const dailyData = {};
        const years = new Set();
        let maxHours = 0;

        console.log(`Processing ${rawData.length} rows with filter: ${currentFilter}`);

        rawData.forEach((row, idx) => {
            const type = row[colIndices.type];
            const movingTimeVal = row[colIndices.time];
            const dateStr = row[colIndices.date];
            const name = row[colIndices.name];
            const distance = row[colIndices.distance];

            if (currentFilter !== 'All' && type !== currentFilter) return;
            if (!dateStr) return;

            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return;

            const movingTimeSec = parseDuration(movingTimeVal);
            if (movingTimeSec <= 0) return;

            // Track year
            years.add(date.getFullYear());

            // Format as YYYY-MM-DD for key
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;

            if (!dailyData[dateKey]) {
                dailyData[dateKey] = {
                    totalHours: 0,
                    activities: []
                };
            }

            const hours = movingTimeSec / 3600;
            dailyData[dateKey].totalHours += hours;
            dailyData[dateKey].activities.push({
                name: name || 'Untitled Activity',
                distance: distance || 0,
                hours: hours,
                type: type || 'Other'
            });

            if (dailyData[dateKey].totalHours > maxHours) {
                maxHours = dailyData[dateKey].totalHours;
            }
        });

        const sortedYears = Array.from(years).sort((a, b) => b - a);
        return { dailyData, maxHours, years: sortedYears };
    }

    function renderHeatmap() {
        const container = document.getElementById('main-heatmap-container');
        container.innerHTML = '';

        if (rawData.length === 0) {
            container.innerHTML = '<div class="loading">No data found.</div>';
            return;
        }

        const { dailyData, maxHours, years } = processData();

        if (years.length === 0) {
            container.innerHTML = '<div class="loading">No valid activities found for this filter.</div>';
            return;
        }

        years.forEach(year => {
            renderYearGrid(year, dailyData, maxHours, container);
        });
    }

    function renderYearGrid(targetYear, dailyData, maxHours, mainContainer) {
        // Create Year Container
        const yearWrapper = document.createElement('div');
        yearWrapper.className = 'heatmap-container';
        yearWrapper.style.marginBottom = '40px';

        // Year Label
        const yearLabel = document.createElement('div');
        yearLabel.className = 'year-label';
        yearLabel.innerText = targetYear;
        yearWrapper.appendChild(yearLabel);

        // Month Labels
        const monthsAxis = document.createElement('div');
        monthsAxis.className = 'months-axis';
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        months.forEach(m => {
            const span = document.createElement('span');
            span.className = 'month-label';
            span.innerText = m;
            monthsAxis.appendChild(span);
        });
        yearWrapper.appendChild(monthsAxis);

        // Grid Container
        const grid = document.createElement('div');
        grid.className = 'heatmap-grid';
        yearWrapper.appendChild(grid);

        mainContainer.appendChild(yearWrapper);

        // Generate Grid
        const startDate = new Date(targetYear, 0, 1);
        const endDate = new Date(targetYear, 11, 31);
        let currentDate = new Date(startDate);

        // Adjust for Monday start
        const dayOfWeek = startDate.getDay(); // 0 is Sunday
        // For Monday start: 0(Sun) -> 6, 1(Mon) -> 0...
        const startOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

        // Spacer cells
        for (let i = 0; i < startOffset; i++) {
            const spacer = document.createElement('div');
            spacer.className = 'day-cell';
            spacer.style.backgroundColor = 'transparent';
            spacer.style.outline = 'none';
            grid.appendChild(spacer);
        }

        // Days
        while (currentDate <= endDate) {
            // Check if we rolled over year (shouldn't happen with logic above but safety)
            if (currentDate.getFullYear() !== targetYear) break;

            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;

            const dayData = dailyData[dateKey] || { totalHours: 0, activities: [] };
            const hours = dayData.totalHours;
            const intensity = calculateIntensity(hours, maxHours);

            const el = document.createElement('div');
            el.className = `day-cell scale-${intensity}`;

            if (dayData.activities.length > 0) {
                el.addEventListener('mouseenter', (e) => showTooltip(e, dayData, currentDate));
                el.addEventListener('mousemove', (e) => moveTooltip(e));
                el.addEventListener('mouseleave', () => hideTooltip());
            }

            grid.appendChild(el);

            currentDate.setDate(currentDate.getDate() + 1);
        }
    }

    // --- Tooltip Logic ---
    let tooltipEl = null;

    function getIcon(type) {
        const t = String(type).toLowerCase();
        if (t.includes('run')) return 'üèÉ';
        if (t.includes('ride') || t.includes('cycling')) return 'üö¥';
        if (t.includes('swim')) return 'üèä';
        if (t.includes('hike') || t.includes('walk')) return 'ü•æ';
        if (t.includes('workout') || t.includes('weight')) return 'üèãÔ∏è';
        return 'üèÖ';
    }

    function showTooltip(e, dayData, dateObj) {
        if (!tooltipEl) {
            tooltipEl = document.createElement('div');
            tooltipEl.className = 'custom-tooltip';
            document.body.appendChild(tooltipEl);
        }

        const dateStr = dateObj.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });

        let html = `<div class="tooltip-date">${dateStr}</div>`;

        dayData.activities.forEach(act => {
            html += `
                <div class="tooltip-activity">
                    <span class="tooltip-icon">${getIcon(act.type)}</span>
                    <div class="tooltip-details">
                        <div class="tooltip-name">${act.name}</div>
                        <div class="tooltip-metrics">
                            ${act.distance ? act.distance.toFixed(2) + ' mi ‚Ä¢ ' : ''}
                            ${act.hours.toFixed(1)}h
                        </div>
                    </div>
                </div>
             `;
        });

        tooltipEl.innerHTML = html;
        tooltipEl.style.display = 'block';
        moveTooltip(e);
    }

    function moveTooltip(e) {
        if (!tooltipEl) return;
        const x = e.clientX + 15;
        const y = e.clientY + 15;

        // Prevent going off screen
        // (Simple check, can be expanded)
        tooltipEl.style.left = x + 'px';
        tooltipEl.style.top = y + 'px';
    }

    function hideTooltip() {
        if (tooltipEl) {
            tooltipEl.style.display = 'none';
        }
    }

    function calculateIntensity(hours, maxHours) {
        if (hours === 0) return 0;
        if (maxHours === 0) return 0;

        const ratio = hours / maxHours;
        if (ratio > 0.75) return 4;
        if (ratio > 0.50) return 3;
        if (ratio > 0.25) return 2;
        return 1;
    }

</script>