<script>
    let rawData = [];
    let currentFilter = 'All';

    // --- Constants ---
    const MS_PER_DAY = 24 * 60 * 60 * 1000;

    // --- Initialization ---
    window.addEventListener('DOMContentLoaded', () => {
        fetchData();
        setupFilters();
    });

    function setupFilters() {
        const buttons = document.querySelectorAll('.filter-btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Remove active class from all
                buttons.forEach(b => b.classList.remove('active'));
                // Add active to clicked
                e.target.classList.add('active');

                currentFilter = e.target.dataset.type;
                renderHeatmap();
            });
        });
    }

    function fetchData() {
        // Show loading?
        google.script.run
            .withSuccessHandler(onDataReceived)
            .withFailureHandler(error => {
                console.error("Error fetching data: ", error);
                document.getElementById('app').innerHTML = `<div class="error">Error loading data.</div>`;
            })
            .getData();
    }

    function onDataReceived(jsonString) {
        try {
            rawData = JSON.parse(jsonString);
            // Remove header row if present
            if (rawData.length > 0 && (rawData[0][0] === 'Activity ID' || rawData[0][0] === 'Header')) {
                rawData.shift();
            }
            renderHeatmap();
        } catch (e) {
            console.error("Error parsing JSON", e);
        }
    }

    function processData() {
        // Map dates to total moving time (hours)
        // Data structure: [ID, Name, Type, MovingTime(sec), StartDate]
        // Filter by type

        const dailyData = {};
        let maxHours = 0;

        rawData.forEach(row => {
            const type = row[2];
            const movingTimeSec = Number(row[3]);
            const dateStr = row[4];

            if (currentFilter !== 'All' && type !== currentFilter) return;
            if (!dateStr) return;

            const date = new Date(dateStr);
            // Format as YYYY-MM-DD for key
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;

            if (!dailyData[dateKey]) dailyData[dateKey] = 0;

            const hours = movingTimeSec / 3600;
            dailyData[dateKey] += hours;

            if (dailyData[dateKey] > maxHours) {
                maxHours = dailyData[dateKey];
            }
        });

        return { dailyData, maxHours };
    }

    function renderHeatmap() {
        const container = document.getElementById('heatmap-grid');
        container.innerHTML = '';

        if (rawData.length === 0) {
            container.innerHTML = '<div class="loading">No data found.</div>';
            return;
        }

        const { dailyData, maxHours } = processData();

        // Determine date range for the current year (or dynamic based on data)
        // For this dashboard, let's show the current calendar year, or the year of the latest data?
        // Let's default to a fixed year for the demo, e.g., 2023, or dynamic.
        // Let's find the min and max year in data, or just default to 2023.
        // Ideally, we start from Jan 1 of the target year.
        const targetYear = 2023;
        const startDate = new Date(targetYear, 0, 1);
        const endDate = new Date(targetYear, 11, 31);

        // We need to pad the start to align with Monday (if we want Mon start) or Sunday (GitHub style is Sunday start usually?)
        // GitHub: Weeks start on Sunday usually for the grid from left to right?
        // Let's assume standard Calendar grid: Columns are weeks.
        // 52-53 weeks.

        // Generating all days
        let currentDate = new Date(startDate);

        // Adjust start date to the previous Sunday (or Monday) to align the grid
        const dayOfWeek = startDate.getDay(); // 0 is Sunday
        // For Monday start: 0(Sun) -> 6, 1(Mon) -> 0, ..., 6(Sat) -> 5
        const startOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

        // We iterate week by week
        // But CSS Grid `grid-auto-flow: column` fills cells down then right.
        // So if we just dump 365+ divs, they will fill column 1 (7 days), then column 2, etc.
        // So we must add "empty" spacer cells at the beginning if Jan 1 is not Sunday.

        // Spacer cells
        for (let i = 0; i < startOffset; i++) {
            const spacer = document.createElement('div');
            spacer.className = 'day-cell';
            spacer.style.backgroundColor = 'transparent'; // Invisible
            spacer.style.outline = 'none';
            container.appendChild(spacer);
        }

        // Days
        while (currentDate <= endDate) {
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;

            const hours = dailyData[dateKey] || 0;
            const intensity = calculateIntensity(hours, maxHours);

            const el = document.createElement('div');
            el.className = `day-cell scale-${intensity}`;

            // Tooltip data
            const dateReadable = currentDate.toDateString();
            const hoursFixed = hours.toFixed(1);
            el.setAttribute('data-tooltip', `${hoursFixed}h on ${dateReadable}`);

            container.appendChild(el);

            // Next day
            currentDate.setDate(currentDate.getDate() + 1);
        }
    }

    function calculateIntensity(hours, maxHours) {
        if (hours === 0) return 0;
        if (maxHours === 0) return 0;

        const ratio = hours / maxHours;
        if (ratio > 0.75) return 4;
        if (ratio > 0.50) return 3;
        if (ratio > 0.25) return 2;
        return 1;
    }

</script>