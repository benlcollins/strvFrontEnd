<script>
    let rawData = [];
    let currentFilter = 'All';
    let colIndices = {
        type: 2,
        time: 3,
        date: 4
    };

    // --- Constants ---
    const MS_PER_DAY = 24 * 60 * 60 * 1000;

    // --- Initialization ---
    window.addEventListener('DOMContentLoaded', () => {
        fetchData();
        setupFilters();
    });

    function setupFilters() {
        const buttons = document.querySelectorAll('.filter-btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Remove active class from all
                buttons.forEach(b => b.classList.remove('active'));
                // Add active to clicked
                e.target.classList.add('active');

                currentFilter = e.target.dataset.type;
                renderHeatmap();
            });
        });
    }

    function fetchData() {
        // Show loading?
        google.script.run
            .withSuccessHandler(onDataReceived)
            .withFailureHandler(error => {
                console.error("Error fetching data: ", error);
                document.getElementById('app').innerHTML = `<div class="error">Error loading data.</div>`;
            })
            .getData();
    }

    function onDataReceived(jsonString) {
        try {
            const data = JSON.parse(jsonString);
            if (data.length === 0) {
                rawData = [];
                renderHeatmap();
                return;
            }

            // Detect headers
            const header = data[0];
            const lowerHeader = header.map(h => String(h).toLowerCase());

            // Helper to find column index
            const findCol = (terms) => {
                return lowerHeader.findIndex(h => terms.some(t => h.includes(t)));
            };

            const typeIdx = findCol(['type', 'activity type']);
            const timeIdx = findCol(['moving time', 'duration', 'time']);
            const dateIdx = findCol(['start date', 'date', 'timestamp']);

            // Update indices if found
            if (typeIdx !== -1) colIndices.type = typeIdx;
            if (timeIdx !== -1) colIndices.time = timeIdx;
            if (dateIdx !== -1) colIndices.date = dateIdx;

            console.log('Detected column indices:', colIndices);

            // Shift if the first row looks like a header (contains "Activity" or "Date")
            if (lowerHeader.some(h => h.includes('activity') || h.includes('date') || h.includes('id'))) {
                data.shift();
            }

            rawData = data;
            renderHeatmap();
        } catch (e) {
            console.error("Error processing data", e);
            document.getElementById('app').innerHTML = `<div class="error">Error processing data.</div>`;
        }
    }

    function parseDuration(val) {
        if (typeof val === 'number') return val;
        if (!val) return 0;

        const str = String(val);

        // Handle HH:mm:ss or mm:ss
        if (str.includes(':') && !str.includes('T')) {
            const parts = str.split(':').map(Number);
            if (parts.length === 3) {
                return (parts[0] * 3600) + (parts[1] * 60) + parts[2];
            } else if (parts.length === 2) {
                return (parts[0] * 60) + parts[1];
            }
        }

        // Handle ISO string from GAS (e.g., 1899-12-30T00:49:03.000Z)
        if (str.includes('T')) {
            const d = new Date(val);
            if (!isNaN(d.getTime())) {
                // durations in Sheets serialized to JSON often look like 1899-12-30T...
                // We want the hours/mins/secs regardless of the date part
                return (d.getHours() * 3600) + (d.getMinutes() * 60) + d.getSeconds();
            }
        }

        const num = Number(val);
        return isNaN(num) ? 0 : num;
    }

    function processData() {
        const dailyData = {};
        const years = new Set();
        let maxHours = 0;

        console.log(`Processing ${rawData.length} rows with filter: ${currentFilter}`);

        // Diagnostic log for first few rows
        if (rawData.length > 0) {
            console.log('Sample data (row 0):', JSON.stringify(rawData[0]));
            console.log('Sample moving time val:', rawData[0][colIndices.time]);
            console.log('Sample parsed duration:', parseDuration(rawData[0][colIndices.time]));
        }

        rawData.forEach((row, idx) => {
            const type = row[colIndices.type];
            const movingTimeVal = row[colIndices.time];
            const dateStr = row[colIndices.date];

            if (currentFilter !== 'All' && type !== currentFilter) return;
            if (!dateStr) return;

            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return;

            const movingTimeSec = parseDuration(movingTimeVal);
            if (movingTimeSec <= 0) return;

            // Track year
            years.add(date.getFullYear());

            // Format as YYYY-MM-DD for key
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;

            if (!dailyData[dateKey]) dailyData[dateKey] = 0;

            const hours = movingTimeSec / 3600;
            dailyData[dateKey] += hours;

            if (dailyData[dateKey] > maxHours) {
                maxHours = dailyData[dateKey];
            }
        });

        const sortedYears = Array.from(years).sort((a, b) => b - a);
        console.log('Processed Data Result:', {
            activeYears: sortedYears,
            maxHours,
            uniqueDays: Object.keys(dailyData).length
        });
        return { dailyData, maxHours, years: sortedYears };
    }

    function renderHeatmap() {
        const container = document.getElementById('main-heatmap-container');
        container.innerHTML = '';

        if (rawData.length === 0) {
            container.innerHTML = '<div class="loading">No data found.</div>';
            return;
        }

        const { dailyData, maxHours, years } = processData();

        if (years.length === 0) {
            container.innerHTML = '<div class="loading">No valid activities found for this filter.</div>';
            return;
        }

        years.forEach(year => {
            renderYearGrid(year, dailyData, maxHours, container);
        });
    }

    function renderYearGrid(targetYear, dailyData, maxHours, mainContainer) {
        // Create Year Container
        const yearWrapper = document.createElement('div');
        yearWrapper.className = 'heatmap-container';
        yearWrapper.style.marginBottom = '40px';

        // Year Label
        const yearLabel = document.createElement('div');
        yearLabel.className = 'year-label';
        yearLabel.innerText = targetYear;
        yearWrapper.appendChild(yearLabel);

        // Month Labels
        const monthsAxis = document.createElement('div');
        monthsAxis.className = 'months-axis';
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        months.forEach(m => {
            const span = document.createElement('span');
            span.className = 'month-label';
            span.innerText = m;
            monthsAxis.appendChild(span);
        });
        yearWrapper.appendChild(monthsAxis);

        // Grid Container
        const grid = document.createElement('div');
        grid.className = 'heatmap-grid';
        yearWrapper.appendChild(grid);

        mainContainer.appendChild(yearWrapper);

        // Generate Grid
        const startDate = new Date(targetYear, 0, 1);
        const endDate = new Date(targetYear, 11, 31);
        let currentDate = new Date(startDate);

        // Adjust for Monday start
        const dayOfWeek = startDate.getDay(); // 0 is Sunday
        // For Monday start: 0(Sun) -> 6, 1(Mon) -> 0...
        const startOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

        // Spacer cells
        for (let i = 0; i < startOffset; i++) {
            const spacer = document.createElement('div');
            spacer.className = 'day-cell';
            spacer.style.backgroundColor = 'transparent';
            spacer.style.outline = 'none';
            grid.appendChild(spacer);
        }

        // Days
        while (currentDate <= endDate) {
            // Check if we rolled over year (shouldn't happen with logic above but safety)
            if (currentDate.getFullYear() !== targetYear) break;

            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;

            const hours = dailyData[dateKey] || 0;
            const intensity = calculateIntensity(hours, maxHours);

            const el = document.createElement('div');
            el.className = `day-cell scale-${intensity}`;

            const dateReadable = currentDate.toDateString();
            const hoursFixed = hours.toFixed(1);
            el.setAttribute('data-tooltip', `${hoursFixed}h on ${dateReadable}`);

            grid.appendChild(el);

            currentDate.setDate(currentDate.getDate() + 1);
        }
    }

    function calculateIntensity(hours, maxHours) {
        if (hours === 0) return 0;
        if (maxHours === 0) return 0;

        const ratio = hours / maxHours;
        if (ratio > 0.75) return 4;
        if (ratio > 0.50) return 3;
        if (ratio > 0.25) return 2;
        return 1;
    }

</script>