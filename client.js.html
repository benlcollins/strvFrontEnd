<script>
    console.log("Client script loaded at global scope.");
    let rawData = [];
    let currentFilter = 'All';
    let colIndices = {
        type: 2,
        time: 3,
        date: 4,
        name: 1,
        distance: 5,
        photos: -1,
        link: -1
    };

    let randomPhotoActivity = null;
    let currentPhotoIndex = 0;

    // --- Constants ---
    const MS_PER_DAY = 24 * 60 * 60 * 1000;

    // --- Initialization ---
    window.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded fired.");
        fetchData();
        setupFilters();

        document.getElementById('reopen-random-photo-btn').addEventListener('click', () => {
            // Check if we have an activity to show
            if (randomPhotoActivity) {
                // If the user clicks reopen, maybe we can pick a new random photo or just show the same one.
                // It's fun to pick a new one, but let's stick to showing the current random photo for now to keep it simple,
                // or actually calling initRandomPhoto() again will pick a new one!
                initRandomPhoto();
            }
        });
    });

    function setupFilters() {
        const buttons = document.querySelectorAll('.filter-btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Remove active class from all
                buttons.forEach(b => b.classList.remove('active'));
                // Add active to clicked
                e.target.classList.add('active');

                currentFilter = e.target.dataset.type;
                renderHeatmap();
            });
        });
    }

    function fetchData() {
        console.log("fetchData() called, requesting getData from server...");
        google.script.run
            .withSuccessHandler(onDataReceived)
            .withFailureHandler(error => {
                console.error("Error fetching data: ", error);
                document.getElementById('main-heatmap-container').innerHTML = `<div class="error">Error loading data: ${error}</div>`;
            })
            .getData();
    }

    function onDataReceived(jsonString) {
        console.log("onDataReceived() called with data length:", jsonString ? jsonString.length : 0);
        try {
            const data = JSON.parse(jsonString);
            if (data.length === 0) {
                console.warn("No data received from server.");
                rawData = [];
                renderHeatmap();
                return;
            }

            // Detect headers
            const header = data[0];
            const lowerHeader = header.map(h => String(h).toLowerCase());

            // Helper to find column index
            const findCol = (terms) => {
                return lowerHeader.findIndex(h => terms.some(t => h.includes(t)));
            };

            const typeIdx = findCol(['type', 'activity type']);
            const timeIdx = findCol(['moving time', 'duration', 'time']);
            const dateIdx = findCol(['start date', 'date', 'timestamp']);
            const nameIdx = findCol(['name', 'activity name', 'title']);
            const distanceIdx = findCol(['distance', 'dist']);
            const photoIdx = findCol(['photos', 'images', 'links', 'media']);
            const linkIdx = findCol(['strava link', 'link', 'url']);

            // Update indices if found
            if (typeIdx !== -1) colIndices.type = typeIdx;
            if (timeIdx !== -1) colIndices.time = timeIdx;
            if (dateIdx !== -1) colIndices.date = dateIdx;
            if (nameIdx !== -1) colIndices.name = nameIdx;
            if (distanceIdx !== -1) colIndices.distance = distanceIdx;
            if (photoIdx !== -1) colIndices.photos = photoIdx;
            if (linkIdx !== -1) colIndices.link = linkIdx;

            console.log('Detected column indices:', colIndices);

            // Shift if the first row looks like a header (contains "Activity" or "Date")
            if (lowerHeader.some(h => h.includes('activity') || h.includes('date') || h.includes('id'))) {
                data.shift();
            }

            rawData = data;
            initRandomPhoto();
            renderHeatmap();
        } catch (e) {
            console.error("Error processing data", e);
            document.getElementById('main-heatmap-container').innerHTML = `<div class="error">Error processing data: ${e.message}</div>`;
        }
    }

    function parseDuration(val) {
        if (typeof val === 'number') return val;
        if (!val) return 0;

        const str = String(val);

        // Handle HH:mm:ss or mm:ss
        if (str.includes(':') && !str.includes('T')) {
            const parts = str.split(':').map(Number);
            if (parts.length === 3) {
                return (parts[0] * 3600) + (parts[1] * 60) + parts[2];
            } else if (parts.length === 2) {
                return (parts[0] * 60) + parts[1];
            }
        }

        // Handle ISO string from GAS (e.g., 1899-12-30T00:49:03.000Z)
        if (str.includes('T')) {
            const d = new Date(val);
            if (!isNaN(d.getTime())) {
                // durations in Sheets serialized to JSON often look like 1899-12-30T...
                // We want the hours/mins/secs regardless of the date part
                return (d.getHours() * 3600) + (d.getMinutes() * 60) + d.getSeconds();
            }
        }

        const num = Number(val);
        return isNaN(num) ? 0 : num;
    }

    function processData() {
        const dailyData = {};
        const years = new Set();
        let maxHours = 0;

        console.log(`Processing ${rawData.length} rows with filter: ${currentFilter}`);

        rawData.forEach((row, idx) => {
            const type = row[colIndices.type];
            const movingTimeVal = row[colIndices.time];
            const dateStr = row[colIndices.date];
            const name = row[colIndices.name];
            const distance = row[colIndices.distance];
            const photoVal = colIndices.photos !== -1 ? row[colIndices.photos] : null;
            const linkVal = colIndices.link !== -1 ? row[colIndices.link] : null;

            if (currentFilter !== 'All' && type !== currentFilter) return;
            if (!dateStr) return;

            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return;

            const movingTimeSec = parseDuration(movingTimeVal);
            if (movingTimeSec <= 0) return;

            // Track year
            years.add(date.getFullYear());

            // Format as YYYY-MM-DD for key
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;

            if (!dailyData[dateKey]) {
                dailyData[dateKey] = {
                    totalHours: 0,
                    activities: []
                };
            }

            const hours = movingTimeSec / 3600;

            // Extract photos (limit to 3)
            let photos = [];
            if (photoVal) {
                photos = String(photoVal).split(/,|\s+/).filter(v => v.trim().startsWith('http')).slice(0, 3);
            }

            dailyData[dateKey].totalHours += hours;
            dailyData[dateKey].activities.push({
                name: name || 'Untitled Activity',
                distance: distance || 0,
                hours: hours,
                type: type || 'Other',
                photos: photos,
                link: linkVal || null
            });

            if (dailyData[dateKey].totalHours > maxHours) {
                maxHours = dailyData[dateKey].totalHours;
            }
        });

        console.log(`Processing complete. Found ${Object.keys(dailyData).length} days with activities.`);
        const sortedYears = Array.from(years).sort((a, b) => b - a);
        return { dailyData, maxHours, years: sortedYears };
    }

    function renderHeatmap() {
        const container = document.getElementById('main-heatmap-container');
        container.innerHTML = '';

        if (rawData.length === 0) {
            container.innerHTML = '<div class="loading">No data found.</div>';
            return;
        }

        const { dailyData, maxHours, years } = processData();

        if (years.length === 0) {
            container.innerHTML = '<div class="loading">No valid activities found for this filter.</div>';
            return;
        }

        years.forEach(year => {
            renderYearGrid(year, dailyData, maxHours, container);
        });
    }

    function renderYearGrid(targetYear, dailyData, maxHours, mainContainer) {
        // Create Year Container
        const yearWrapper = document.createElement('div');
        yearWrapper.className = 'heatmap-container';
        yearWrapper.style.marginBottom = '40px';

        // Year Label
        const yearLabel = document.createElement('div');
        yearLabel.className = 'year-label';
        yearLabel.innerText = targetYear;
        yearWrapper.appendChild(yearLabel);

        // Month Labels
        const monthsAxis = document.createElement('div');
        monthsAxis.className = 'months-axis';
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        months.forEach(m => {
            const span = document.createElement('span');
            span.className = 'month-label';
            span.innerText = m;
            monthsAxis.appendChild(span);
        });
        yearWrapper.appendChild(monthsAxis);

        // Grid Container
        const grid = document.createElement('div');
        grid.className = 'heatmap-grid';
        yearWrapper.appendChild(grid);

        mainContainer.appendChild(yearWrapper);

        // Generate Grid
        const startDate = new Date(targetYear, 0, 1);
        const endDate = new Date(targetYear, 11, 31);
        let currentDate = new Date(startDate);

        // Adjust for Monday start
        const dayOfWeek = startDate.getDay(); // 0 is Sunday
        // For Monday start: 0(Sun) -> 6, 1(Mon) -> 0...
        const startOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

        // Spacer cells
        for (let i = 0; i < startOffset; i++) {
            const spacer = document.createElement('div');
            spacer.className = 'day-cell';
            spacer.style.backgroundColor = 'transparent';
            spacer.style.outline = 'none';
            grid.appendChild(spacer);
        }

        // Days
        while (currentDate <= endDate) {
            // Check if we rolled over year (shouldn't happen with logic above but safety)
            if (currentDate.getFullYear() !== targetYear) break;

            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;

            const dayData = dailyData[dateKey] || { totalHours: 0, activities: [] };
            const hours = dayData.totalHours;
            const intensity = calculateIntensity(hours, maxHours);

            const el = document.createElement('div');
            el.className = `day-cell scale-${intensity}`;

            if (dayData.activities.length > 0) {
                const capturedDate = new Date(currentDate);
                el.addEventListener('mouseenter', (e) => showTooltip(e, dayData, capturedDate));
                el.addEventListener('mousemove', (e) => moveTooltip(e));
                el.addEventListener('mouseleave', () => hideTooltip());

                // Add click event to open Strava links
                el.addEventListener('click', () => {
                    dayData.activities.forEach(act => {
                        if (act.link) {
                            window.open(act.link, '_blank');
                        }
                    });
                });
            }

            grid.appendChild(el);

            currentDate.setDate(currentDate.getDate() + 1);
        }
    }

    // --- Random Photo Logic ---
    function initRandomPhoto() {
        const activitiesWithPhotos = [];
        rawData.forEach(row => {
            const photoVal = colIndices.photos !== -1 ? row[colIndices.photos] : null;
            if (photoVal) {
                const photos = String(photoVal).split(/,|\s+/).filter(v => v.trim().startsWith('http'));
                if (photos.length > 0) {
                    activitiesWithPhotos.push({
                        row: row,
                        photos: photos
                    });
                }
            }
        });

        if (activitiesWithPhotos.length > 0) {
            const randomIndex = Math.floor(Math.random() * activitiesWithPhotos.length);
            const selected = activitiesWithPhotos[randomIndex];

            const type = selected.row[colIndices.type] || 'Activity';
            const name = selected.row[colIndices.name] || 'Untitled Activity';
            const distance = selected.row[colIndices.distance] || 0;
            const timeVal = selected.row[colIndices.time];
            const movingTimeSec = parseDuration(timeVal);
            const hours = movingTimeSec / 3600;
            const link = colIndices.link !== -1 ? selected.row[colIndices.link] : null;

            // Format date if available
            let dateFormatted = '';
            const dateStr = selected.row[colIndices.date];
            if (dateStr) {
                const dateObj = new Date(dateStr);
                if (!isNaN(dateObj.getTime())) {
                    dateFormatted = dateObj.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                }
            }

            randomPhotoActivity = {
                type, name, distance, hours, link, photos: selected.photos, date: dateFormatted
            };

            currentPhotoIndex = 0;
            renderRandomPhoto();
            document.getElementById('random-photo-container').style.display = 'block';
            document.getElementById('reopen-random-photo-btn').style.display = 'none';
        } else {
            document.getElementById('random-photo-container').style.display = 'none';
            document.getElementById('reopen-random-photo-btn').style.display = 'none';
        }
    }

    function renderRandomPhoto() {
        if (!randomPhotoActivity) return;

        let photoUrl = randomPhotoActivity.photos[currentPhotoIndex];

        // Update Image
        const imgEl = document.getElementById('rp-img-display');
        if (imgEl) imgEl.src = photoUrl;

        // Arrows
        const leftArrow = document.getElementById('rp-btn-prev');
        const rightArrow = document.getElementById('rp-btn-next');
        if (randomPhotoActivity.photos.length > 1) {
            if (leftArrow) leftArrow.style.display = 'flex';
            if (rightArrow) rightArrow.style.display = 'flex';
        } else {
            if (leftArrow) leftArrow.style.display = 'none';
            if (rightArrow) rightArrow.style.display = 'none';
        }

        // Title link
        const titleContainer = document.getElementById('rp-title-display');
        if (titleContainer) {
            if (randomPhotoActivity.link) {
                titleContainer.innerHTML = `<a href="${randomPhotoActivity.link}" target="_blank" class="rp-activity-name">${randomPhotoActivity.name}</a>`;
            } else {
                titleContainer.innerHTML = `<div class="rp-activity-name">${randomPhotoActivity.name}</div>`;
            }
        }

        // Date display
        const dateContainer = document.getElementById('rp-date-display');
        if (dateContainer) {
            if (randomPhotoActivity.date) {
                dateContainer.innerText = randomPhotoActivity.date;
                dateContainer.style.display = 'block';
            } else {
                dateContainer.style.display = 'none';
            }
        }

        // Meta display
        const metaContainer = document.getElementById('rp-meta-display');
        if (metaContainer) {
            metaContainer.innerHTML = `
                <span>${getIcon(randomPhotoActivity.type)} ${randomPhotoActivity.type}</span>
                <span>‚Ä¢</span>
                <span>${randomPhotoActivity.distance ? parseFloat(randomPhotoActivity.distance).toFixed(2) + ' mi' : '0 mi'}</span>
                <span>‚Ä¢</span>
                <span>${randomPhotoActivity.hours.toFixed(1)}h</span>
            `;
        }
    }

    function changeRandomPhoto(dir) {
        if (!randomPhotoActivity) return;
        currentPhotoIndex += dir;
        if (currentPhotoIndex < 0) currentPhotoIndex = randomPhotoActivity.photos.length - 1;
        if (currentPhotoIndex >= randomPhotoActivity.photos.length) currentPhotoIndex = 0;
        renderRandomPhoto();
    }

    function closeRandomPhoto() {
        document.getElementById('random-photo-container').style.display = 'none';
        document.getElementById('reopen-random-photo-btn').style.display = 'block';
    }

    // --- Tooltip Logic ---
    let tooltipEl = null;

    function getIcon(type) {
        const t = String(type).toLowerCase();
        if (t.includes('run')) return 'üèÉ';
        if (t.includes('ride') || t.includes('cycling')) return 'üö¥';
        if (t.includes('swim')) return 'üèä';
        if (t.includes('hike') || t.includes('walk')) return 'ü•æ';
        if (t.includes('workout') || t.includes('weight')) return 'üèãÔ∏è';
        return 'üèÖ';
    }

    function showTooltip(e, dayData, dateObj) {
        if (!tooltipEl) {
            tooltipEl = document.createElement('div');
            tooltipEl.className = 'custom-tooltip';
            document.body.appendChild(tooltipEl);
        }

        const dateStr = dateObj.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });

        let html = `< div class="tooltip-date" > ${dateStr}</div > `;

        dayData.activities.forEach(act => {
            let photosHtml = '';
            if (act.photos && act.photos.length > 0) {
                photosHtml = `< div class="tooltip-photos" > `;
                act.photos.forEach(url => {
                    photosHtml += `< img src = "${url}" class="tooltip-thumb" alt = "Activity photo" > `;
                });
                photosHtml += `</div > `;
            }

            html += `
                < div class="tooltip-activity" >
                    <span class="tooltip-icon">${getIcon(act.type)}</span>
                    <div class="tooltip-details">
                        <div class="tooltip-name">${act.name}</div>
                        <div class="tooltip-metrics">
                            ${act.distance ? act.distance.toFixed(2) + ' mi ‚Ä¢ ' : ''}
                            ${act.hours.toFixed(1)}h
                        </div>
                        ${photosHtml}
                    </div>
                </div >
             `;
        });

        tooltipEl.innerHTML = html;
        tooltipEl.style.display = 'block';
        moveTooltip(e);
    }

    function moveTooltip(e) {
        if (!tooltipEl) return;
        const x = e.clientX + 15;
        const y = e.clientY + 15;

        tooltipEl.style.left = x + 'px';
        tooltipEl.style.top = y + 'px';
    }

    function hideTooltip() {
        if (tooltipEl) {
            tooltipEl.style.display = 'none';
        }
    }

    function calculateIntensity(hours, maxHours) {
        if (hours === 0) return 0;
        if (maxHours === 0) return 0;

        const ratio = hours / maxHours;
        if (ratio > 0.75) return 4;
        if (ratio > 0.50) return 3;
        if (ratio > 0.25) return 2;
        return 1;
    }

</script>